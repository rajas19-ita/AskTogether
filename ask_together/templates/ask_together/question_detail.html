{% extends 'base.html' %}
{% load static %}
    
{% block title %}
    {{question.title}}
{% endblock %}


{% block content %}
    {% include 'ask_together/includes/header.html' %}
    <div class="container min-vh-100">  
        <div class="at-layout"> 
            <div class="at-sidebar-wrapper">
                {% include 'ask_together/includes/sidebar.html' %}
            </div>
            <div class="at-sidebar-overlay"></div>
            <main class="at-content-container">
                <div class="mb-3">
                    <div class="pb-1 at-border-bottom">
                        <h1 class="fw-normal fs-3">{{question.title}}</h1>
                    </div> 
                    <div class="pt-4 d-flex gap-4">
                        <div class="">
                            {% include 'ask_together/components/vote_block.html' with type='question' id=question.id total_votes=total_votes  user_vote=user_vote %}
                        </div>
                        <div class="d-flex flex-column flex-grow-1 ">
                            <div class="pb-4 at-rich-content">
                                {{question.description|safe}}
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="d-flex align-items-center gap-2 at-bg-primary-100 rounded-1 px-2 py-1" >            
                                    <div class="d-flex align-items-center gap-1 at-text-secondary small">
                                        <span class="">Asked</span>
                                        <span class="datetime" data-dt="{{ question.created_at|date:'c' }}">
                                            {{ question.created_at|date:"M d, Y H:i" }}
                                        </span>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dot" viewBox="0 0 16 16">
                                        <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/>
                                    </svg>    
                                    <div class="d-flex align-items-center gap-1">
                                        <img class="at-avatar at-avatar-sm" src="{% if question.user.profile_image %}{{question.user.profile_image.url}}{% else %}{% static 'ask_together/img/default_profile.jpg' %}{% endif %}"/>
                                        <span class="mb-0 at-text-brand-primary small">{{question.user.username}}</span>
                                    </div> 
                                </div>        
                            </div>
                            {% include 'ask_together/components/comments.html' with type="question" id=question.id first_comments=first_comments user=user has_more_comments=has_more_comments last_comment_id=last_comment_id %}
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h3 id="answer_count" class="fs-5 fw-normal">{{question.answers.count}} Answer{{question.answers.count|pluralize}}</h3>
                </div>
                {% if answers %}
                    <div class="d-flex justify-content-center mb-3">
                        <span class="d-flex align-items-center gap-3">
                            {% if answers.has_previous %}
                                <a href="?page=1" class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-left" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8.354 1.646a.5.5 0 0 1 0 .708L2.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                                        <path fill-rule="evenodd" d="M12.354 1.646a.5.5 0 0 1 0 .708L6.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                                    </svg>
                                </a>
                                <a href="?page={{ answers.previous_page_number }}"  class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                                    </svg>
                                </a>
                            {% endif %}
    
                            <span class="current">
                                {{ answers.number }} of {{ answers.paginator.num_pages }}
                            </span>
    
                            {% if answers.has_next %}
                                <a href="?page={{ answers.next_page_number }}" class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                                    </svg>
                                </a>
                                <a href="?page={{ answers.paginator.num_pages }}" class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M3.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L9.293 8 3.646 2.354a.5.5 0 0 1 0-.708"/>
                                        <path fill-rule="evenodd" d="M7.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L13.293 8 7.646 2.354a.5.5 0 0 1 0-.708"/>
                                    </svg>
                                </a>
                            {% endif %}
                        </span>
                    </div>
                {% endif %}
                <div id="answer_container">
                    {% for ans in answers %}
                        {% include 'ask_together/components/answer.html' with ctx=ans only %}
                    {% endfor %}
                </div>
                {% if answers %}
                    <div class="d-flex justify-content-center mt-3">
                        <span class="d-flex align-items-center gap-3">
                            {% if answers.has_previous %}
                                <a href="?page=1" class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-left" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8.354 1.646a.5.5 0 0 1 0 .708L2.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                                        <path fill-rule="evenodd" d="M12.354 1.646a.5.5 0 0 1 0 .708L6.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                                    </svg>
                                </a>
                                <a href="?page={{ answers.previous_page_number }}"  class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                                    </svg>
                                </a>
                            {% endif %}
    
                            <span class="current">
                                {{ answers.number }} of {{ answers.paginator.num_pages }}
                            </span>
    
                            {% if answers.has_next %}
                                <a href="?page={{ answers.next_page_number }}" class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                                    </svg>
                                </a>
                                <a href="?page={{ answers.paginator.num_pages }}" class="at-btn-pagination">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M3.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L9.293 8 3.646 2.354a.5.5 0 0 1 0-.708"/>
                                        <path fill-rule="evenodd" d="M7.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L13.293 8 7.646 2.354a.5.5 0 0 1 0-.708"/>
                                    </svg>
                                </a>
                            {% endif %}
                        </span>
                    </div>
                {% endif %}
                <div class="mt-3">
                    <form id="answer_form" >
                        {% csrf_token %}
                        <label for="id_content" class="fs-5 mb-2">Your Answer:</label>
                        {{answer_form.content}}
                        {% if user.is_authenticated %}
                            <button type="submit" class="at-btn at-btn-brand fw-normal mt-2">Post Your Answer</button>
                        {% else %}
                            <a href="{% url 'ask_together:login' %}?ssrc=post_answer" class="at-btn at-btn-brand fw-normal mt-2">
                                Post Your Answer
                            </a>
                        {% endif %}
                    </form>
                </div>
            </main>
        </div>
    </div>
{% endblock %}
{% block script_block %}
    <script>
        formatUTCtoLocal()

        const formEl = document.getElementById("answer_form");
        let acceptedAnswer = {% if question.accepted_answer %}{{question.accepted_answer.id}}{% else %}null{% endif %}

        const handleSubmit = (e)=>{
            e.preventDefault()

            const answer = formEl.querySelector('#id_content').value
            const csrfToken = formEl.querySelector('[name=csrfmiddlewaretoken]').value

            fetch("{% url 'ask_together:answer_create' %}",{
                method:'POST',
                headers:{
                    'Content-Type':"application/json",
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({content:answer, question: {{question.id}}})
            })
            .then(res =>{
                if(res.ok){
                    return res.json()
                }else{
                    return res.json().then((err)=> {throw err})
                }
            })
            .then(data =>{
                //remove form error on success and reset form
                formEl.querySelector('.at-error-msg')?.remove()
                formEl.reset()
                const iframe = document.getElementById("id_content_iframe");
                const editable = iframe.contentDocument.querySelector('.note-editable')
                if(editable){
                    editable.innerHTML = ''
                }

                //update answer count
                const countEl = document.getElementById("answer_count");
                if (countEl) {
                    let current = parseInt(countEl.textContent);
                    if (!isNaN(current)) {
                        let newCount = current + 1;
                        countEl.textContent = `${newCount} Answer${newCount !== 1 ? 's' : ''}`;
                    }
                }

                //add answer to UI
                addAnswerToUI(data.html)                
            }) 
            .catch(err =>{
                const p = document.createElement('p')
                p.className = 'at-error-msg text-danger mb-1';
                if(err.content){
                    p.textContent = err.content[0]
                }else{
                    p.textContent = 'some error occurred'  
                }
                formEl.appendChild(p)
            })   
        } 

        const addAnswerToUI = (answer)=>{
            const container = document.getElementById("answer_container");
            container.insertAdjacentHTML("beforeend", answer);
            formatUTCtoLocal(container) 
        }

        formEl.addEventListener("submit",handleSubmit)

        const handleVote = (type, id, action, button)=>{
            let actionMap = {upvote:1, downvote:-1}
            let value = actionMap[action]

            if (button.classList.contains('active')){
                action = 'remove'
            }
            
            const csrfToken = formEl.querySelector('[name=csrfmiddlewaretoken]').value

            let url = type==='question' ? `{% url 'ask_together:vote_question' 0 %}`.replace('0',`${id}`):
                                         `{% url 'ask_together:vote_answer' 0 %}`.replace('0',`${id}`)

            
            fetch(`${url}`,{
                method:'POST',
                headers:{
                    'Content-Type':"application/json",
                    'X-CSRFToken':csrfToken
                },
                body:JSON.stringify({action})
            })
            .then(res =>{
                if(res.ok){
                    return res.json()
                }else{
                    return res.json().then((err)=> {throw err})
                }
            })
            .then(data=>{
                let activeAction = ''
                document.querySelectorAll(`.${type+id}-vote-btn`).forEach((btn)=>{
                    if(btn.classList.contains('active')){
                        activeAction = btn.dataset.action
                        btn.classList.remove('active')
                    }
                })
                spanEl = document.getElementById(`${type+id}_vote_count`)
                let vote_count = parseInt(spanEl.innerHTML)


                if(action === 'remove'){
                    vote_count -= value
                }else{
                    button.classList.add('active')
                    if(activeAction){
                        vote_count -= actionMap[activeAction]
                    }
                    vote_count += value
                }

                spanEl.innerHTML = vote_count
            })
            .catch(err =>{
                console.log(err)
            }) 

        }

        const handleCommentFormDisplay = (type, id, button)=>{
            let btnType = button.dataset.btn
            let commentForm = document.getElementById(`${type+id}_comment_form`)
            if(btnType === "show"){
                button.classList.add('d-none')
                commentForm.classList.remove('d-none')
            }else{
                commentForm.reset()
                commentForm.querySelector(`#${type+id}_comment_error`)?.remove()
                document.getElementById(`${type+id}_comment_btn`).classList.remove('d-none')
                commentForm.classList.add('d-none')
            }
        }

        const handleCommentSubmit = (e, type, id, form)=>{
            e.preventDefault()
            let content = document.getElementById(`${type+id}_comment_content`).value
            
            const csrfToken = formEl.querySelector('[name=csrfmiddlewaretoken]').value
            
            fetch(`{% url 'ask_together:comment_create' %}`,{
                method:'POST',
                headers:{
                    'Content-Type':"application/json",
                    'X-CSRFToken':csrfToken
                },
                body:JSON.stringify({
                    content:content.trim(),
                    [type]:id
                })
            })
            .then(res =>{
                if(res.ok){
                    return res.json()
                }else{
                    return res.json().then((err)=> {throw err})
                }
            })
            .then(data=>{
                form.querySelector(`#${type+id}_comment_error`)?.remove()
                form.reset()
                addCommentToUi(data.html, type, id)
                document.getElementById(`${type+id}_comment_btn`).classList.remove('d-none')
                form.classList.add('d-none')
            })
            .catch(err=>{
                const p = document.createElement('p')
                p.id = `${type+id}_comment_error`
                p.className = ' text-danger mb-1';
                if(err.content){
                    p.textContent = err.content[0]
                }else{
                    p.textContent = 'some error occurred'  
                }
                form.appendChild(p)
            })

        }   

        const addCommentToUi = (comment,type,id)=>{
            const container = document.getElementById(`${type+id}_comments_container`)
            container.insertAdjacentHTML("beforeend", comment);
            formatUTCtoLocal(container)                           
        }

        const handleAcceptedAnswer = (id, button)=>{
            const csrfToken = formEl.querySelector('[name=csrfmiddlewaretoken]').value

            const url = "{% url 'ask_together:answer_accept' question.id %}"

            let method, body = null;

            if (acceptedAnswer === id){
                method = "DELETE"
            }else{
                method = "POST"
                body = JSON.stringify({answer:id})
            }

            fetch(url,{
                method,
                headers:{
                    'X-CSRFToken': csrfToken,
                    ...(body && {'Content-Type':'application/json'})
                },
                ...(body && { body })
            })
            .then((res)=>res.ok?res.json():res.json().then((err)=>{throw err}))
            .then(data=>{
                const prev = acceptedAnswer
                acceptedAnswer = data.accepted_answer

                if (prev !== null && prev !== id) {
                    updateAcceptedAnswerUI(prev, false);
                }

                updateAcceptedAnswerUI(id, acceptedAnswer === id);
            })
            .catch(err=>console.log(err))
        }

        function updateAcceptedAnswerUI(answerId, isAccepted) {
            const btn = document.getElementById(`answer${answerId}_acc_btn`);
            if (!btn) return;

            btn.querySelectorAll("svg").forEach(svg => {
                const accepted = svg.dataset.accepted === "true";
                if (accepted === isAccepted) {
                    svg.classList.remove("d-none");
                } else {
                    svg.classList.add("d-none");
                }
            });
        }


        const fetchMoreComments = (type, id, button)=>{
            const csrfToken = formEl.querySelector('[name=csrfmiddlewaretoken]').value
            const last_id = button.dataset.lastCommentId

            fetch(`{% url 'ask_together:get_comments' %}?${type==="question"?'question_id':'answer_id'}=${id}&last_id=${last_id}`,{
                method:'GET',
                headers:{
                    'X-CSRFToken': csrfToken
                }
            })
            .then(res =>{
                if(res.ok){
                    return res.json()
                }else{
                    return res.json().then((err)=> {throw err})
                }
            })
            .then(data =>{
                data.comments.forEach((comment)=>addCommentToUi(comment.html, type, id))
                button.dataset.lastCommentId = data.last_id
                if(!data.has_more){
                    button.classList.add('d-none')
                }

            })
            .catch(err => {console.log(err)})
        }

    </script>
{% endblock %}