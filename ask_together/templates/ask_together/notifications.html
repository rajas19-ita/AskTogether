{% extends 'base.html' %}
{% load static %}


{% block title %}
    Notifications
{% endblock %}

{% block content %}
    {% include 'ask_together/includes/header.html' %}
    <main class="min-vh-100">
        <div class="container">
            <div class="d-flex min-vh-100">
                {% include 'ask_together/includes/sidebar.html' %}
                <div class="pb-4 px-4 border-start flex-grow-1 d-flex flex-column">
                    <div class="w-100 d-flex flex-column gap-3 ps-5" style="max-width:650px">
                        <h1 class="fs-3 pt-4">Notifications</h1>
                        <div class="tabs">
                            <button class="at-btn at-btn-text at-btn-tabs active" data-type="unread" onClick="switchTab(this)">Unread</button>
                            <button class="at-btn at-btn-text at-btn-tabs" data-type="read" onClick="switchTab(this)">Read</button>
                        </div>
                        <div class=" at-tab-content active" id="unread_notifications">
                            <p class="text-center at-text-secondary d-none" id="no_unread_msg">
                                No Unread Notifications
                            </p>
                            <img src={% static 'ask_together/img/loading_gif.gif' %} class="align-self-center d-none" id="unread_loading_gif" style=""/>
                            <button class="at-btn at-btn-text d-none" id="load_more_unread" onClick="loadMoreNotifications(this, 'unread')">Load More</button>
                        </div> 
                        <div class=" at-tab-content" id="read_notifications">
                            <p class="text-center at-text-secondary d-none" id="no_read_msg">
                                No Read Notifications
                            </p>
                            <img src={% static 'ask_together/img/loading_gif.gif' %} class="align-self-center d-none" id="read_loading_gif" style=""/>
                            <button class="at-btn at-btn-text d-none" id="load_more_read" onClick="loadMoreNotifications(this, 'read')">Load More</button>
                        </div>     
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block script_block %}
<script>
    const tabs = document.querySelectorAll('.at-btn-tabs') 
    const tabContents = document.querySelectorAll('.at-tab-content')
    let nextUnread = null
    let nextRead = null
    const unreadLoadingGif = document.getElementById('unread_loading_gif')
    const readLoadingGif = document.getElementById('read_loading_gif')


    const switchTab = (button)=>{
        let type = button.dataset.type

        tabs.forEach((btn)=>btn.classList.remove('active'))
        tabContents.forEach((tabC=>tabC.classList.remove('active')))


        button.classList.add('active')
        document.getElementById(`${type}_notifications`).classList.add('active')
    }

    const notificationSVG = (notification)=>{
        switch(notification.event_type){
            case 'ANSWER_POSTED':
                return `
                    <div class="col-1 d-flex justify-content-center align-self-start mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                        </svg>
                    </div>`
            case 'COMMENT_ON_QUESTION':
            case 'COMMENT_ON_ANSWER':
                return `
                    <div class="col-1 d-flex justify-content-center align-self-start mt-2">    
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-chat-left" viewBox="0 0 16 16">
                            <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                        </svg>
                    </div>`
            case 'ANSWER_SELECTED':
                return `
                    <div class="col-1 d-flex justify-content-center align-self-start mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="34" height="34" viewBox="0 0 20 20" class="">
                            <path d="M8.294 16.998c-.435 0-.847-.203-1.111-.553L3.61 11.724a1.392 1.392 0 0 1 .27-1.951 1.392 1.392 0 0 1 1.953.27l2.351 3.104 5.911-9.492a1.396 1.396 0 0 1 1.921-.445c.653.406.854 1.266.446 1.92L9.478 16.34a1.39 1.39 0 0 1-1.12.656c-.022.002-.042.002-.064.002z"/>
                        </svg>
                    </div>`
            case 'UPVOTE_MILESTONE':
                return `
                    <div class="col-1 d-flex justify-content-center align-self-start mt-1">
                        <div class="d-flex flex-column align-items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
                                <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                            </svg>
                            <span class="fw-bold small" >${notification.upvotes}</span>
                        </div>
                    </div>`
        }
    }


    const fetchNotifications = (type, next=null)=>{
        return fetch(`{% url 'ask_together:get_notifications' %}?is_read=${type==="read"}${next?`&cursor_id=${next}`:''}`,{
                    headers:{
                        'X-CSRFToken': '{{csrfToken}}'
                    },
            }).then((res =>{
                    if(res.ok){
                        return res.json()
                    }else{
                        return res.json().then((err)=> {throw err})
                    }
            })).then((data)=>{
                return data
            }).catch((err)=>{
                console.log(err)
            })
    
    }
    const addNotificationToUI = (notification, type)=>{
        const container = document.getElementById(`${type}_notifications`)

        const wrapper = document.createElement('div')
        wrapper.className = "px-2 py-2 row border g-0 gap-2"

        wrapper.innerHTML = `
                ${notificationSVG(notification)}
                <div class="col-9 d-flex flex-column">
                    <p class="at-font-roboto fs-6 mb-0">
                        <a href=${'{% url "ask_together:question_detail" 0 %}'.replace('0',notification.question.id)} target="_blank" class="text-decoration-none">
                            ${notification.message}
                        </a>
                    </p>
                    <span class="at-text-secondary small" data-dt="${notification.created_at}">
                        ${timeAgo(notification.created_at)}
                    </span>
                </div>
        `
        container.appendChild(wrapper)
    }

    const renderReadNotifications = (data)=>{
        const container = document.getElementById(`read_notifications`)

        data.forEach((notification)=>addNotificationToUI(notification, 'read'))

        let loadMoreBtn = document.getElementById('load_more_read')
        if(data.length){
            loadMoreBtn.classList.remove('d-none')
            container.appendChild(loadMoreBtn)
        }else{
            loadMoreBtn.classList.add('d-none')
        }

    }

    const renderUnreadNotifications = (data)=>{
        const container = document.getElementById(`unread_notifications`)
        
        data.forEach((notification)=>addNotificationToUI(notification, 'unread'))
        let loadMoreBtn = document.getElementById('load_more_unread')
        if(data.length){
            loadMoreBtn.classList.remove('d-none')
            container.appendChild(loadMoreBtn)
        }else{
            loadMoreBtn.classList.add('d-none')
        }
    }


    const fetchInitialNotifications =()=>{
        readLoadingGif.classList.remove('d-none')
        unreadLoadingGif.classList.remove('d-none')
        Promise.all([fetchNotifications('read'),fetchNotifications('unread')])
        .then((data)=>{
            readLoadingGif.classList.add('d-none')
            unreadLoadingGif.classList.add('d-none')
            nextRead = data[0].next_cursor
            nextUnread = data[1].next_cursor
            
            if(data[0].data.length !== 0){
                renderReadNotifications(data[0].data)
            }else{
                document.getElementById('no_read_msg').classList.remove('d-none')
            }
            if(data[1].data.length !== 0){
                renderUnreadNotifications(data[1].data)
            }else{
                document.getElementById('no_unread_msg').classList.remove('d-none')
            }
        })

    } 
    fetchInitialNotifications()

    const loadMoreNotifications  = (button, type)=>{
        button.classList.add('d-none')
        if(type==='read'){ 
            document.getElementById(`${type}_notifications`).append(readLoadingGif)
            readLoadingGif.classList.remove('d-none')
        }else{
            document.getElementById(`${type}_notifications`).append(unreadLoadingGif)
            unreadLoadingGif.classList.remove('d-none')
        }
        fetchNotifications(type, type==='read'?nextRead:nextUnread)
        .then((data)=>{
            readLoadingGif.classList.add('d-none')
            unreadLoadingGif.classList.add('d-none')
            if(type ==='read'){
                nextRead = data.next_cursor
                renderReadNotifications(data.data)
            }else{
                nextUnread = data.next_cursor
                renderUnreadNotifications(data.data)
            }
        })
    }

</script>
{% endblock %}